# Multi-stage build for EnergyPlus validator container
#
# Build context must be vb_validators/ (not validators/energyplus/)
# Build with: docker build -f validators/energyplus/Dockerfile -t ... .

# =============================================================================
# Stage 1: Build EnergyPlus
# =============================================================================
FROM ubuntu:22.04 AS energyplus-builder

# Install EnergyPlus build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

# Download and install EnergyPlus 25.2.0 (latest as of Dec 2024)
# Update this URL for different EnergyPlus versions
# Check releases at: https://github.com/NREL/EnergyPlus/releases
RUN wget -q https://github.com/NREL/EnergyPlus/releases/download/v25.2.0/EnergyPlus-25.2.0-cf7368216c-Linux-Ubuntu22.04-x86_64.tar.gz \
    && tar -xzf EnergyPlus-25.2.0-cf7368216c-Linux-Ubuntu22.04-x86_64.tar.gz \
    && mv EnergyPlus-25.2.0-cf7368216c-Linux-Ubuntu22.04-x86_64 /opt/energyplus \
    && rm EnergyPlus-25.2.0-cf7368216c-Linux-Ubuntu22.04-x86_64.tar.gz

# =============================================================================
# Stage 2: Runtime container
# =============================================================================
FROM python:3.13-slim

# Install runtime dependencies
# - libgomp1: OpenMP runtime for parallel processing
# - libx11-6, libxext6: X11 libs required by EnergyPlus binary
# - git: needed for pip install from GitHub
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 \
    libx11-6 \
    libxext6 \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy EnergyPlus from builder stage
COPY --from=energyplus-builder /opt/energyplus /opt/energyplus

# Add EnergyPlus to PATH
ENV PATH="/opt/energyplus:${PATH}"

# Set working directory
WORKDIR /app

# Add /app to PYTHONPATH so imports like "from validators.core.x" work
ENV PYTHONPATH="/app:${PYTHONPATH}"

# Copy requirements first (for layer caching)
COPY validators/energyplus/requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy the entire validators package (includes core, energyplus, and __init__.py)
COPY validators /app/validators

# Create working directory for EnergyPlus runs
RUN mkdir -p /tmp/energyplus_run

# Run as a module so relative imports work correctly
CMD ["python", "-m", "validators.energyplus.main"]
